# –ú–æ–¥—É–ª—å 4: –õ–æ–≥–∏–∫–∞ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‚Äî –ú–∞–∫—Ä–æ—Å—ã (Jinja)

–ù–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç—Ç–∞–ø–∞—Ö –º—ã –Ω–∞—É—á–∏–ª–∏—Å—å —Å—Ç—Ä–æ–∏—Ç—å –º–æ–¥–µ–ª–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Ö –∫–∞—á–µ—Å—Ç–≤–æ. –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –Ω–∞—à –∫–æ–¥ –±–æ–ª–µ–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–º, —á–∏—Ç–∞–µ–º—ã–º –∏ –ø—Ä–æ—Å—Ç—ã–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ. –í —ç—Ç–æ–º –Ω–∞–º –ø–æ–º–æ–≥—É—Ç **–º–∞–∫—Ä–æ—Å—ã**.

**–¶–µ–ª—å:** –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞—Ç—å (–ø—Ä—è—Ç–∞—Ç—å) —Å–ª–æ–∂–Ω—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å –ø–æ–º–æ—â—å—é –º–∞–∫—Ä–æ—Å–æ–≤.

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –º–∞–∫—Ä–æ—Å –≤ dbt ‚Äî —ç—Ç–æ –∫–∞–∫ **–≤–∞—à–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤ Excel** –∏–ª–∏ **—Ñ—É–Ω–∫—Ü–∏—è –≤ Python**. –í—ã –æ–¥–∏–Ω —Ä–∞–∑ –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É, –¥–∞–µ—Ç–µ –µ–π –∏–º—è, –∞ –∑–∞—Ç–µ–º –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç–µ –ø–æ —ç—Ç–æ–º—É –∏–º–µ–Ω–∏ –≥–¥–µ —É–≥–æ–¥–Ω–æ, –ø–µ—Ä–µ–¥–∞–≤–∞—è –Ω—É–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. üßë‚Äçüíª

---

## –¢–µ–æ—Ä–∏—è

### –ß—Ç–æ —Ç–∞–∫–æ–µ Jinja?

**Jinja** ‚Äî —ç—Ç–æ —è–∑—ã–∫ —à–∞–±–ª–æ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è "—Å—É–ø–µ—Ä—Å–∏–ª–æ–π" dbt. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –≤ –≤–∞—à–∏ SQL-—Ñ–∞–π–ª—ã. –° –ø–æ–º–æ—â—å—é Jinja –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
* **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**: `{{ var('my_variable') }}`
* **–£—Å–ª–æ–≤–∏—è**: `{% if ... %}`
* **–¶–∏–∫–ª—ã**: `{% for ... in ... %}`
* **–ú–∞–∫—Ä–æ—Å—ã**: `{% macro ... %}`

–ö–æ–≥–¥–∞ –≤—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –∫–æ–º–∞–Ω–¥—É `dbt run`, dbt —Å–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Jinja-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤–∞—à —à–∞–±–ª–æ–Ω–Ω—ã–π `.sql` —Ñ–∞–π–ª –≤ —á–∏—Å—Ç—ã–π, –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π SQL. –≠—Ç–æ—Ç –∏—Ç–æ–≥–æ–≤—ã–π –∫–æ–¥ –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –≤ –ø–∞–ø–∫–µ `target/compiled/`, —á—Ç–æ –æ—á–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ.

### –ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞–∫—Ä–æ—Å?

**–ú–∞–∫—Ä–æ—Å** ‚Äî —ç—Ç–æ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –±–ª–æ–∫ Jinja/SQL –∫–æ–¥–∞. –ï–≥–æ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—É **DRY (Don't Repeat Yourself)**, –∏–ª–∏ "–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è".

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?**
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 10 —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö. –ï—Å–ª–∏ –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç—É –ª–æ–≥–∏–∫—É, –±–µ–∑ –º–∞–∫—Ä–æ—Å–∞ –ø—Ä–∏–¥–µ—Ç—Å—è –≤–Ω–æ—Å–∏—Ç—å –ø—Ä–∞–≤–∫–∏ –≤ 10 —Ñ–∞–π–ª–∞—Ö. –° –º–∞–∫—Ä–æ—Å–æ–º ‚Äî —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º. –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –æ—à–∏–±–æ–∫ –∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è.

–ú–∞–∫—Ä–æ—Å—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –¥–µ–ª–∞—è –≤–∞—à –ø—Ä–æ–µ–∫—Ç –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º –∏ –ø—Ä–æ—Å—Ç—ã–º –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è.

---

## –ü—Ä–∞–∫—Ç–∏–∫–∞

### –ó–∞–¥–∞—á–∞ 3.1: –°–æ–∑–¥–∞–µ–º –º–∞–∫—Ä–æ—Å

–ú—ã –≤–∏–¥–µ–ª–∏, —á—Ç–æ `payment_type` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –≤–∏–¥–µ —á–∏—Å–µ–ª (`1`, `2`, –∏ —Ç.–¥.). –≠—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è, –Ω–æ –Ω–µ—É–¥–æ–±–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤ –≤ BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –º–∞–∫—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —á–∏—Å–ª–æ–≤–æ–π –∫–æ–¥ –≤ –ø–æ–Ω—è—Ç–Ω—É—é —á–µ–ª–æ–≤–µ–∫—É —Å—Ç—Ä–æ–∫—É.

1.  –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª `macros/get_payment_type_description.sql`.
2.  –í—Å—Ç–∞–≤—å—Ç–µ –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥ –Ω–∞ Jinja/SQL:

```sql
-- macros/get_payment_type_description.sql

{% macro get_payment_type_description(payment_type_column) %}

    case {{ payment_type_column }}
        when 1 then 'Credit card'
        when 2 then 'Cash'
        when 3 then 'No charge'
        when 4 then 'Dispute'
        else 'Unknown'
    end

{% endmacro %}
````

*–ó–¥–µ—Å—å `get_payment_type_description` ‚Äî —ç—Ç–æ –∏–º—è –Ω–∞—à–µ–≥–æ –º–∞–∫—Ä–æ—Å–∞, –∞ `payment_type_column` ‚Äî –∞—Ä–≥—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º –≤ –Ω–µ–≥–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, –∏–º—è —Å—Ç–æ–ª–±—Ü–∞).*

### –ó–∞–¥–∞—á–∞ 3.2: –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Ä–æ—Å –≤ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤–∏—Ç—Ä–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö (`mart`) `fct_trips`, –≥–¥–µ –±—É–¥—É—Ç —Å–æ–±—Ä–∞–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –æ –ø–æ–µ–∑–¥–∫–∞—Ö, –∏ –ø—Ä–∏–º–µ–Ω–∏–º –Ω–∞—à –Ω–æ–≤—ã–π –º–∞–∫—Ä–æ—Å.

1.  –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª `models/marts/fct_trips.sql`.
2.  –í—Å—Ç–∞–≤—å—Ç–µ –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π SQL-–∑–∞–ø—Ä–æ—Å. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –∫–∞–∫ –º—ã –≤—ã–∑—ã–≤–∞–µ–º –º–∞–∫—Ä–æ—Å ‚Äî –ø–æ—á—Ç–∏ –∫–∞–∫ –æ–±—ã—á–Ω—É—é SQL-—Ñ—É–Ω–∫—Ü–∏—é.

<!-- end list -->

```sql
-- models/marts/fct_trips.sql

{{
  config(
    materialized='table'
  )
}}

select
    -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
    vendor_id,
    pickup_location_id,
    dropoff_location_id,

    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    pickup_datetime,
    dropoff_datetime,
    
    -- –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–µ–∑–¥–∫–∏
    passenger_count,
    trip_distance,
    
    -- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    fare_amount,
    tip_amount,
    total_amount,

    -- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–∞–∫—Ä–æ—Å–∞
    payment_type,
    {{ get_payment_type_description('payment_type') }} as payment_type_description

from {{ ref('stg_yellow_tripdata') }}
```

*–ú—ã –¥–æ–±–∞–≤–∏–ª–∏ –±–ª–æ–∫ `config`, —á—Ç–æ–±—ã —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å dbt –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç—Ç—É –º–æ–¥–µ–ª—å –∫–∞–∫ `table`. –í–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞—é—Ç —Ç–∞–±–ª–∏—Ü–∞–º–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –Ω–∏–º –∏–∑ BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.*

### –ó–∞–¥–∞—á–∞ 3.3: –ó–∞–ø—É—Å–∫–∞–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º

1.  –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤–∞—à–µ–π –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏:

    ```bash
    docker compose exec dbt dbt run --select fct_trips
    ```

2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ó–∞–π–¥–∏—Ç–µ –≤ –≤–∞—à –∫–ª–∏–µ–Ω—Ç Postgres. –í —Ü–µ–ª–µ–≤–æ–π —Å—Ö–µ–º–µ –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è **—Ç–∞–±–ª–∏—Ü–∞** `fct_trips`. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –Ω–µ–π –µ—Å—Ç—å —Å—Ç–æ–ª–±–µ—Ü `payment_type_description` —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (`Credit card`, `Cash` –∏ —Ç.–¥.).

-----

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

–ò–∑—É—á–µ–Ω–∏–µ –º–∞–∫—Ä–æ—Å–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –ª–æ–≥–∏–∫. –í–æ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –≤–∞–º —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ —Ç–µ–º—É:

  * [**Jinja –∏ –ú–∞–∫—Ä–æ—Å—ã**](https://docs.getdbt.com/docs/build/jinja-macros)
  * [**–§—É–Ω–∫—Ü–∏—è `config`**](https://docs.getdbt.com/reference/dbt-jinja-functions/config)
  * [**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Variables)**](https://docs.getdbt.com/docs/build/project-variables)
