# Модуль 1: Анатомия dbt-проекта

Прежде чем мы начнем писать код, давайте разберемся, как устроен dbt-проект. Понимание того, какой файл за что отвечает и где искать информацию для отладки, сэкономит вам массу времени в будущем.

---

## 1. Структура папок проекта

Когда вы создаете dbt-проект, он генерирует стандартную структуру папок. Давайте рассмотрим основные из них.
* **`models/`**: Сердце вашего проекта. Здесь вы будете проводить 90% времени. Каждый `.sql` файл в этой папке — это одна модель (таблица или view в базе данных).
* **`macros/`**: Папка для Jinja-макросов. Если у вас есть повторяющийся SQL-код, вы можете обернуть его в макрос, чтобы не копировать его постоянно.
* **`tests/`**: Здесь хранятся "singular" тесты — кастомные SQL-запросы для проверки сложной бизнес-логики.
* **`seeds/`**: Используется для загрузки небольших статических данных из CSV-файлов, например, справочников (дни недели, статусы и т.д.).
* **`dbt_project.yml`**: Главный файл конфигурации. Здесь вы определяете имя проекта, версии, пути и задаете конфигурации для моделей по умолчанию (например, материализацию).
* **`profiles.yml`**: Файл с настройками подключения к вашему хранилищу данных (Postgres, BigQuery и т.д.). **Важно:** Этот файл обычно лежит за пределами папки проекта и **не должен** попадать в Git, так как содержит пароли и ключи доступа.

---

## 2. Слои и нейминг: Best Practices

Чтобы проект не превратился в хаос, принято разделять модели на логические слои. Это делает поток данных (lineage) понятным и предсказуемым.



### Основные слои:

1.  **Staging (Стейджинг) - `stg_`**
    * **Назначение:** Самый первый слой трансформаций. Модели здесь напрямую читают данные из `sources`.
    * **Задачи:** Переименование столбцов в единый стиль (`snake_case`), базовое приведение типов, очень легкая очистка.
    * **Правило:** Одна стейджинг-модель на один источник. Никаких `JOIN`'ов.
    * **Нейминг:** `stg_<source_name>`. Например: `stg_yellow_tripdata`.

2.  **Intermediate (Промежуточный) - `int_`**
    * **Назначение:** Необязательный слой для сложных трансформаций.
    * **Задачи:** Объединение (`JOIN`) нескольких стейджинг-моделей, подготовка данных для агрегации, сложные оконные функции. Используется, чтобы не создавать одну гигантскую и нечитаемую финальную модель.
    * **Нейминг:** `int_<business_entity>`. Например: `int_trips_with_payment_info`.

3.  **Marts (Витрины) - `fct_`, `dim_`**
    * **Назначение:** Финальный слой. Эти модели предоставляются конечным пользователям (аналитикам) или подключаются к BI-инструментам (Metabase, Tableau).
    * **Задачи:** Агрегация данных до нужного уровня гранулярности, формирование бизнес-сущностей.
    * **Нейминг:**
        * `dim_<business_entity>` (**Dimensions** - измерения): таблицы-справочники (клиенты, продукты, календарь). Например: `dim_zones`.
        * `fct_<business_process>` (**Facts** - факты): таблицы с событиями или транзакциями, которые можно посчитать (поездки, заказы, платежи). Например: `fct_trips`.

---

## 3. Служебные папки: `target/` и `logs/`

Эти папки создаются и управляются dbt автоматически. **Никогда не редактируйте файлы в них вручную!** Они удаляются и пересоздаются при каждом запуске.

### `logs/`

Здесь лежит файл `dbt.log`. Это ваш лучший друг при отладке. Если команда `dbt run` упала с ошибкой, первое, что нужно сделать — открыть этот файл и посмотреть детальное описание проблемы. Он содержит все шаги, которые dbt предпринял, и точные тексты ошибок от базы данных.

### `target/`

Это "сборочный цех" вашего проекта. Самые полезные папки внутри:

* **`compiled/`**: Здесь лежит **скомпилированный** SQL. Когда вы используете Jinja (`{{ ref(...) }}`, макросы, `if/else`), dbt сначала превращает это в чистый SQL, и только потом отправляет в базу. В этой папке вы можете увидеть итоговый SQL-код, который был сгенерирован для каждой модели. **Это незаменимо для отладки сложной Jinja-логики.**
* **`run/`**: Здесь лежит **выполненный** SQL. Он очень похож на `compiled`, но обернут в DDL-инструкции (`create view ... as ...`). Показывает, что именно dbt отправил в базу для создания или изменения модели.
* **`manifest.json`**: "Мозг" вашего проекта. Огромный JSON-файл, который описывает все ресурсы проекта (модели, тесты, источники и связи между ними). Используется для построения графа зависимостей и генерации документации.

---

## 4. Полезеные ссылки и документация

* [**What is dbt?**](https://docs.getdbt.com/docs/introduction)
* [**Структура проекта**](https://docs.getdbt.com/docs/build/projects)
* [**Как должен выглядеть проект**](https://discourse.getdbt.com/t/how-we-used-to-structure-our-dbt-projects/355)
