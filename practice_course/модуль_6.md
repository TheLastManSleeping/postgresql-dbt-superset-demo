# –ú–æ–¥—É–ª—å 6: –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

–≠—Ç–æ—Ç –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –ø–æ–¥–≤–æ–¥–∏—Ç –∏—Ç–æ–≥–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –µ—â–µ –º–æ—â–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ dbt, —á—Ç–æ–±—ã —É –≤–∞—Å –±—ã–ª –ø–ª–∞–Ω –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.

---

## –ß—Ç–æ –º—ã –∏–∑—É—á–∏–ª–∏? –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä

–ó–∞ –≤—Ä–µ–º—è —ç—Ç–æ–≥–æ –≤–æ—Ä–∫—à–æ–ø–∞ –º—ã –Ω–∞—É—á–∏–ª–∏—Å—å:
* **–ü–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (`sources`)**: –û–±—ä—è–≤–ª—è—Ç—å –≤ dbt –Ω–∞—à–∏ "—Å—ã—Ä—ã–µ" –¥–∞–Ω–Ω—ã–µ.
* **–°—Ç—Ä–æ–∏—Ç—å –º–æ–¥–µ–ª–∏ (`models`)**: –°–æ–∑–¥–∞–≤–∞—Ç—å SQL-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å—è—Ç –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞ (`ref`).
* **–û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö (`tests`)**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ (generic) –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ (singular) —Ç–µ—Å—Ç—ã, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (`freshness`).
* **–ü–∏—Å–∞—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥ (`macros`)**: –£–±–∏—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Jinja-–º–∞–∫—Ä–æ—Å–æ–≤.
* **–°–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (`docs`)**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –∏ –≥—Ä–∞—Ñ–æ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (DAG).

–≠—Ç–æ ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –¥–ª—è –ª—é–±–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞.

---

## –ö—É–¥–∞ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ? –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

dbt ‚Äî —ç—Ç–æ –æ—á–µ–Ω—å –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å –±–æ–≥–∞—Ç—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º. –í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –∏–∑—É—á–∏—Ç—å –¥–∞–ª—å—à–µ.

### 1. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Incremental Models)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞—à–∞ –º–æ–¥–µ–ª—å `fct_trips` —Å–µ–π—á–∞—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –∫–∞–∫ `table`. –ß—Ç–æ, –µ—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –±—É–¥—É—Ç –º–∏–ª–ª–∏–∞—Ä–¥—ã —Å—Ç—Ä–æ–∫? –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å —á–∞—Å—ã.

**–†–µ—à–µ–Ω–∏–µ:** –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏. –û–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç dbt –¥–æ–ø–∏—Å—ã–≤–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É —Ç–æ–ª—å–∫–æ **–Ω–æ–≤—ã–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ** –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –µ–µ —Ü–µ–ª–∏–∫–æ–º.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?** –í—ã –º–µ–Ω—è–µ—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ `incremental` –∏ —Å –ø–æ–º–æ—â—å—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π Jinja-—Ñ—É–Ω–∫—Ü–∏–∏ `{{ is_incremental() }}` –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –≤ `WHERE` —É—Å–ª–æ–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–±–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏.

```sql
-- models/marts/fct_trips.sql

{{
  config(
    materialized='incremental'
  )
}}

select * from {{ ref('stg_yellow_tripdata') }}

{% if is_incremental() %}
  -- –ø—Ä–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
  where pickup_datetime > (select max(pickup_datetime) from {{ this }})
{% endif %}
````

### 2\. –ü–∞–∫–µ—Ç—ã (Packages)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ß–∞—Å—Ç–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –∑–∞–¥–∞—á–∏: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–π –∫–ª—é—á, –≤—ã–ø–æ–ª–Ω–∏—Ç—å `unpivot` —Ç–∞–±–ª–∏—Ü—ã, –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å.

**–†–µ—à–µ–Ω–∏–µ:** –ü–∞–∫–µ—Ç—ã dbt. –≠—Ç–æ –≥–æ—Ç–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–∞–∫—Ä–æ—Å–æ–≤ –∏ –º–æ–¥–µ–ª–µ–π, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º. –°–∞–º—ã–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞–∫–µ—Ç ‚Äî **dbt-utils**.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?** –í—ã —Å–æ–∑–¥–∞–µ—Ç–µ —Ñ–∞–π–ª `packages.yml`, —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ –≤ –Ω–µ–º –Ω—É–∂–Ω—ã–π –ø–∞–∫–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –∫–æ–º–∞–Ω–¥—É `dbt deps`, –∏ –≤—Å–µ –º–∞–∫—Ä–æ—Å—ã –∏–∑ —ç—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ.

```yaml
# packages.yml
packages:
  - package: dbt-labs/dbt_utils
    version: 1.1.1
```

### 3\. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (dbt-expectations)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã (`unique`, `not_null`) –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ –Ω–µ **—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞** –¥–∞–Ω–Ω—ã—Ö. –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø–æ–µ–∑–¥–∫–∏ –Ω–µ —É–ø–∞–ª–∞ –Ω–∏–∂–µ $5 –∏–ª–∏ —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–µ–∑–¥–æ–∫ —Å 0 –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 1% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞?

**–†–µ—à–µ–Ω–∏–µ:** –ü–∞–∫–µ—Ç **dbt-expectations**. –≠—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å –¥–µ—Å—è—Ç–∫–∞–º–∏ –≥–æ—Ç–æ–≤—ã—Ö, –º–æ—â–Ω—ã—Ö generic-—Ç–µ—Å—Ç–æ–≤, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π Great Expectations.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?** –í—ã –ø–æ–¥–∫–ª—é—á–∞–µ—Ç–µ –ø–∞–∫–µ—Ç, –∫–∞–∫ –∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π, –∞ –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –≤ —Å–≤–æ–∏—Ö `.yml` —Ñ–∞–π–ª–∞—Ö.

```yaml
# models/staging/schema.yml
models:
  - name: fct_trips
    columns:
      - name: total_amount
        tests:
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ 99% –ø–æ–µ–∑–¥–æ–∫ —Å—Ç–æ—è—Ç –æ—Ç 0 –¥–æ 1000 –¥–æ–ª–ª–∞—Ä–æ–≤
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1000
              strictly: false
              row_condition: "passenger_count > 0"
              mismatch_threshold: 0.01
```

### 4\. –°–Ω—ç–ø—à–æ—Ç—ã (Snapshots)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è. –ù–∞–ø—Ä–∏–º–µ—Ä, –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞. –ö–∞–∫ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫–∞–∫–∏–º –±—ã–ª —Å—Ç–∞—Ç—É—Å –Ω–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü? –≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ Slowly Changing Dimensions (SCD).

**–†–µ—à–µ–Ω–∏–µ:** `dbt snapshot`. –≠—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç dbt –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Ö –∏—Å—Ç–æ—Ä–∏—é.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?** –í—ã —Å–æ–∑–¥–∞–µ—Ç–µ `.sql` —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ `snapshots/`. –í –Ω–µ–º –≤—ã —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ, –∑–∞ –∫–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ–π —Å–ª–µ–¥–∏—Ç—å –∏ –ø–æ –∫–∞–∫–æ–º—É –∫–ª—é—á—É –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ `dbt snapshot` dbt –±—É–¥–µ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é —Ç–∞–±–ª–∏—Ü—É, –ø—Ä–æ—Å—Ç–∞–≤–ª—è—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ `dbt_valid_from` –∏ `dbt_valid_to`.

```sql
-- snapshots/zones_snapshot.sql

{% snapshot zones_snapshot %}

{{
    config(
      target_schema='snapshots',
      strategy='timestamp',
      unique_key='location_id',
      updated_at='updated_at',
    )
}}

select * from {{ ref('dim_zones') }}

{% endsnapshot %}
```

-----

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–ø–µ—Ä—å –≤—ã –≥–æ—Ç–æ–≤—ã –∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–º—É –ø–ª–∞–≤–∞–Ω–∏—é –≤ –º–∏—Ä–µ dbt\! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –∏–∑—É—á–∞—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ–º—ã –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ. –î–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤ –ø—Ä–µ–¥–ª–∞–≥–∞—é —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –∏–∑ —Ñ–∞–π–ª–∞ **test_tasks.md** –£—Å–ø–µ—Ö–æ–≤\! üöÄ

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

  * [**–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏**](https://docs.getdbt.com/docs/build/incremental-models)
  * [**–ü–∞–∫–µ—Ç—ã –∏ dbt Hub**](https://hub.getdbt.com/) (–º–µ—Å—Ç–æ, –≥–¥–µ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤—Å–µ –ø–∞–∫–µ—Ç—ã)
  * [**–ü–∞–∫–µ—Ç dbt-expectations**](https://github.com/calogica/dbt-expectations)
  * [**–°–Ω—ç–ø—à–æ—Ç—ã (Snapshots)**](https://docs.getdbt.com/docs/build/snapshots)
  * [**Exposures**](https://docs.getdbt.com/docs/build/exposures) (–¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–æ–≤ –∏ –æ—Ç—á–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–∞—à–∏ –º–æ–¥–µ–ª–∏)
  * [**–ù–µ–ø–ª–æ—Ö–æ–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫—É—Ä—Å –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—á—Ç–∏ –≤—Å–µ —Ç–µ–º—ã**](https://youtube.com/playlist?list=PLzvuaEeolxkyx7XruoatSFdYDyLji_o1J&si=Tq0NALz_ddEHGFOp)

